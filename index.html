<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>デカブサ漢字クロス（総合・開発用）</title>

<style>
  :root{
    --bg:#f2f2f2;
    --panel:#ffffff;
    --text:#111;
    --muted:#666;
    --line:#d8d8d8;
    --btn:#ddd;
    --btnActive:#999;
    --danger:#d33;
  }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    text-align:center;
  }

  /* できるだけスクロールさせない（端末差で少しだけ出る場合はあり） */
  .screen{
    max-width:420px;
    margin:0 auto;
    height:100svh;
    padding:12px 12px 10px;
    box-sizing:border-box;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .title{
    font-size:14px;
    color:var(--muted);
    text-align:left;
  }
  .smallbtn{
    border:none;
    background:var(--btn);
    padding:10px 12px;
    border-radius:12px;
    font-size:12px;
  }

  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:16px;
  }

  /* キャラ表示 */
  .charPanel{
    padding:10px;
  }
  .charImgWrap{
    height:120px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    border-radius:14px;
    background:#fff;
  }
  .charImgWrap img{
    max-height:110px;
    max-width:100%;
    object-fit:contain;
    display:block;
  }

  .message{
    font-size:22px;
    font-weight:800;
    letter-spacing:0.02em;
    padding:6px 0 0;
    user-select:none;
  }

  /* 問題（縦横の矢印） */
  .crossWrap{
    flex:1;
    padding:14px 12px;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:0; /* flexのはみ出し防止 */
  }

  .cross{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
  }

  .vcol{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    font-size:42px;
    line-height:1;
  }
  .arrow{
    font-size:34px;
    line-height:1;
  }

  /* 入力枠（IME対応：ここは「複数文字OK」にする） */
  .boxInput{
    width:150px;
    height:110px;
    border:3px dashed #bdbdbd;
    border-radius:18px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    box-sizing:border-box;
  }
  .boxInput input{
    width:100%;
    height:100%;
    border:none;
    outline:none;
    background:transparent;
    text-align:center;
    font-size:56px;
    font-weight:800;
    padding:0 10px;
    box-sizing:border-box;
  }

  .hrow{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    font-size:40px;
    font-weight:800;
    flex-wrap:wrap;
  }

  /* 下部：ステータスと判定 */
  .statusRow{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:13px;
    color:var(--muted);
    padding:0 4px;
    user-select:none;
  }

  .judgeBtn{
    border:none;
    background:#bdbdbd;
    color:#222;
    border-radius:16px;
    padding:14px 0;
    font-size:18px;
    font-weight:800;
  }
  .judgeBtn:active{ filter:brightness(0.95); }

  /* キャラバー */
  .character-bar{
    display:flex;
    gap:8px;
  }
  .character-bar button{
    flex:1;
    padding:10px 0;
    font-size:12px;
    border:none;
    border-radius:12px;
    background:var(--btn);
  }
  .character-bar button.active{
    background:var(--btnActive);
    color:#fff;
  }

  /* 結果トースト（正誤表示） */
  .toast{
    position:fixed;
    left:50%;
    top:18px;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    padding:10px 14px;
    border-radius:14px;
    font-size:14px;
    font-weight:800;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
    z-index:50;
  }
  .toast.show{ opacity:0.92; }
  .toast.bad{ background:var(--danger); }

  /* ===== キャラ紹介オーバーレイ ===== */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:center;
    justify-content:center;
    padding:16px;
    box-sizing:border-box;
    z-index:60;
  }
  .overlay.show{ display:flex; }

  .sheet{
    width:min(420px, 100%);
    background:var(--panel);
    border-radius:16px;
    border:1px solid var(--line);
    overflow:hidden;
  }
  .sheetHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:12px 12px;
    border-bottom:1px solid var(--line);
  }
  .sheetHeader .h{
    font-size:13px;
    color:var(--muted);
  }
  .closeBtn{
    border:none;
    background:var(--btn);
    padding:10px 12px;
    border-radius:12px;
    font-size:12px;
  }

  .profileArea{ padding:14px 14px 10px; }
  .profileCard{
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
  }
  .profileTop{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .avatarImg{
    width:92px;
    height:92px;
    border-radius:14px;
    background:#fff;
    border:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .avatarImg img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    display:block;
  }
  .profileText{ text-align:left; flex:1; }
  .name{ font-size:18px; font-weight:900; margin-bottom:4px; }
  .ability{ font-size:13px; color:var(--muted); margin-bottom:8px; }
  .desc{ font-size:13px; line-height:1.5; color:#222; }
  .quote{
    margin-top:10px;
    padding-top:10px;
    border-top:1px dashed var(--line);
    font-size:13px;
    color:#222;
  }

  .navRow{
    display:flex;
    gap:8px;
    padding:10px 14px 14px;
  }
  .navRow button{
    flex:1;
    border:none;
    background:var(--btn);
    padding:12px 0;
    border-radius:12px;
    font-size:12px;
    font-weight:800;
  }
  .pager{
    padding:0 14px 14px;
    font-size:12px;
    color:var(--muted);
    user-select:none;
  }
  .hintRow{
    padding:0 14px 14px;
    font-size:12px;
    color:var(--muted);
    user-select:none;
  }
  .note{
    padding:12px 14px 14px;
    border-top:1px solid var(--line);
    font-size:12px;
    color:var(--muted);
    line-height:1.5;
    text-align:left;
  }
</style>
</head>

<body>

<div class="toast" id="toast"></div>

<div class="screen">

  <div class="topbar">
    <div class="title">デカブサ漢字クロス（総合・開発用）</div>
    <button class="smallbtn" id="openIntroBtn">キャラ紹介</button>
  </div>

  <div class="panel charPanel">
    <div class="charImgWrap">
      <img id="mainCharImg" src="img/dekabusa.png" alt="character">
    </div>
    <div class="message" id="message">一字、入力して</div>
  </div>

  <div class="panel crossWrap">
    <div class="cross">
      <div class="vcol">
        <div>安</div>
        <div class="arrow">↓</div>

        <div class="boxInput">
          <!-- IME対応：maxlength付けない。判定時に1文字にする -->
          <input id="answerInput" type="text" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="">
        </div>

        <div class="arrow">↓</div>
        <div>中</div>
      </div>

      <div style="height:6px"></div>

      <div class="hrow">
        <span>決</span>
        <span style="font-size:30px">→</span>
        <span style="display:inline-block;border:3px solid #111;border-radius:6px;width:28px;height:28px;line-height:28px;"></span>
        <span style="font-size:30px">→</span>
        <span>配</span>
      </div>
    </div>
  </div>

  <div class="statusRow">
    <div id="qLabel">問題 1 / ∞（テスト）</div>
    <div><span id="missLabel">ミス 0 / 3</span>　|　<span id="bestLabel">最高 0</span></div>
  </div>

  <button class="judgeBtn" id="judgeBtn">判定</button>

  <div class="character-bar" id="charBar"></div>

</div>

<!-- キャラ紹介オーバーレイ -->
<div class="overlay" id="introOverlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true">
    <div class="sheetHeader">
      <div class="h">キャラ紹介（雰囲気だけ変わります）</div>
      <button class="closeBtn" id="closeIntroBtn">閉じる</button>
    </div>

    <div class="profileArea">
      <div class="profileCard" id="profileCard">
        <div class="profileTop">
          <div class="avatarImg"><img id="introAvatarImg" src="img/dekabusa.png" alt=""></div>
          <div class="profileText">
            <div class="name" id="introName">デカブサ</div>
            <div class="ability" id="introAbility">能力：特になし</div>
            <div class="desc" id="introDesc">何も教えない。褒めない。怒らない。</div>
          </div>
        </div>
        <div class="quote" id="introQuote">代表： 「……」</div>
      </div>
    </div>

    <div class="navRow">
      <button id="prevBtn">←</button>
      <button id="useBtn">このキャラにする</button>
      <button id="nextBtn">→</button>
    </div>

    <div class="pager" id="pager">1 / 5</div>
    <div class="hintRow">左右にスワイプでも切り替え可</div>

    <div class="note">
      追加キャラは、<b>表示</b>と<b>文言</b>が変わるだけです。<br>
      やること（漢字を1字入れて判定）は変わりません。
    </div>
  </div>
</div>

<script>
  // ===== キャラ定義（画像パスが肝） =====
  const characters = [
    {
      id:"dekabusa",
      name:"デカブサ",
      img:"img/dekabusa.png",
      ability:"能力：特になし",
      desc:"何も教えない。褒めない。怒らない。",
      quote:"代表： 「……」",
      message:"一字、入力して"
    },
    {
      id:"gori",
      name:"ゴリさん",
      img:"img/gori.png",
      ability:"能力：タイムリープ",
      desc:"未来が分かる。けど言わない。変えない。",
      quote:"代表： 「……この未来だった」",
      message:"……この未来だった"
    },
    {
      id:"tora",
      name:"トラさん",
      img:"img/tora.png",
      ability:"能力：分身",
      desc:"分身できる。だからって何もしない。",
      quote:"代表： 「……」",
      message:"静かに入力しろ"
    },
    {
      id:"king",
      name:"キング",
      img:"img/king.png",
      ability:"能力：時を止める",
      desc:"褒めるときは止めて拍手3回。",
      quote:"代表： 「（止めて拍手）」",
      message:"王は見ている"
    },
    {
      id:"ani",
      name:"デカブサ兄",
      img:"img/ani.png",
      ability:"能力：加速装置",
      desc:"速い。けど反応は薄い。空気だけ重い。",
      quote:"代表： （なし）",
      message:"……"
    }
  ];

  // ===== ゲーム状態 =====
  let selectedIndex = 0;
  let introIndex = 0;
  let miss = 0;
  let cleared = 0;
  let best = Number(localStorage.getItem("dekabusa_best") || "0");

  // テスト問題（今は固定）
  const current = {
    // 正解1文字（ここだけ変えれば判定が動く）
    answer: "全"
  };

  // ===== UI参照 =====
  const charBar = document.getElementById("charBar");
  const mainCharImg = document.getElementById("mainCharImg");
  const messageEl = document.getElementById("message");
  const inputEl = document.getElementById("answerInput");
  const missLabel = document.getElementById("missLabel");
  const bestLabel = document.getElementById("bestLabel");
  const qLabel = document.getElementById("qLabel");
  const toast = document.getElementById("toast");
  const judgeBtn = document.getElementById("judgeBtn");

  // ===== トースト =====
  let toastTimer = null;
  function showToast(text, bad=false){
    toast.textContent = text;
    toast.classList.toggle("bad", bad);
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toast.classList.remove("show"), 650);
  }

  // ===== キャラバー =====
  function buildCharBar(){
    charBar.innerHTML = "";
    characters.forEach((c, i)=>{
      const b = document.createElement("button");
      b.textContent = c.name;
      b.onclick = ()=>selectChar(i);
      if(i === selectedIndex) b.classList.add("active");
      charBar.appendChild(b);
    });
  }

  function selectChar(i){
    selectedIndex = i;
    const c = characters[i];
    mainCharImg.src = c.img;
    mainCharImg.alt = c.name;
    messageEl.textContent = c.message;

    // active更新
    Array.from(charBar.querySelectorAll("button")).forEach((b, idx)=>{
      b.classList.toggle("active", idx === selectedIndex);
    });
  }

  // ===== 判定（IME対策：最後の1文字だけ採用） =====
  function getOneCharForJudge(){
    // 全角スペースも除去
    const raw = (inputEl.value || "").replace(/\s|　/g, "");
    if(!raw) return "";
    // 末尾1文字（変換確定後の最終文字を取りやすい）
    return raw.slice(-1);
  }

  function setLabels(){
    missLabel.textContent = `ミス ${miss} / 3`;
    bestLabel.textContent = `最高 ${best}`;
    qLabel.textContent = `問題 ${cleared + 1} / ∞（テスト）`;
  }

  function gameOver(){
    // 最高更新
    if(cleared > best){
      best = cleared;
      localStorage.setItem("dekabusa_best", String(best));
    }
    setLabels();
    showToast(`ゲームオーバー（最高 ${best}）`, true);

    // ここで「1コマ漫画」を出す案にしやすい（今はアラートで仮）
    setTimeout(()=>{
      alert(`ゲームオーバー\n最高 ${best}\n\n（ここに1コマ漫画を出すの良い）`);
      // リスタート
      miss = 0;
      cleared = 0;
      inputEl.value = "";
      setLabels();
    }, 250);
  }

  function judge(){
    const ch = getOneCharForJudge();
    if(!ch){
      showToast("入力しろ", true);
      return;
    }

    if(ch === current.answer){
      cleared++;
      showToast("正解");
      inputEl.value = "";
      setLabels();
      // 本来は次の問題へ（今はテストなので同じ）
    }else{
      miss++;
      showToast("不正解", true);
      setLabels();
      if(miss >= 3){
        gameOver();
      }
    }
  }

  judgeBtn.addEventListener("click", judge);

  // Enterで判定（iOSの「完了」相当）
  inputEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){
      e.preventDefault();
      judge();
    }
  });

  // ===== キャラ紹介 =====
  const overlay = document.getElementById("introOverlay");
  const introAvatarImg = document.getElementById("introAvatarImg");

  function openIntro(){
    introIndex = selectedIndex;
    renderIntro();
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
  }
  function closeIntro(){
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }
  function renderIntro(){
    const c = characters[introIndex];
    introAvatarImg.src = c.img;
    document.getElementById("introName").textContent = c.name;
    document.getElementById("introAbility").textContent = c.ability;
    document.getElementById("introDesc").textContent = c.desc;
    document.getElementById("introQuote").textContent = c.quote;
    document.getElementById("pager").textContent = `${introIndex + 1} / ${characters.length}`;
  }
  function introPrev(){ introIndex = (introIndex - 1 + characters.length) % characters.length; renderIntro(); }
  function introNext(){ introIndex = (introIndex + 1) % characters.length; renderIntro(); }
  function useThisChar(){ selectChar(introIndex); closeIntro(); }

  document.getElementById("openIntroBtn").addEventListener("click", openIntro);
  document.getElementById("closeIntroBtn").addEventListener("click", closeIntro);
  document.getElementById("prevBtn").addEventListener("click", introPrev);
  document.getElementById("nextBtn").addEventListener("click", introNext);
  document.getElementById("useBtn").addEventListener("click", useThisChar);

  overlay.addEventListener("click", (e)=>{ if(e.target === overlay) closeIntro(); });

  // スワイプ
  let sx=0, sy=0, tracking=false;
  const card = document.getElementById("profileCard");
  card.addEventListener("touchstart",(e)=>{
    const t=e.touches[0]; sx=t.clientX; sy=t.clientY; tracking=true;
  },{passive:true});
  card.addEventListener("touchend",(e)=>{
    if(!tracking) return;
    tracking=false;
    const t=e.changedTouches[0];
    const dx=t.clientX-sx, dy=t.clientY-sy;
    if(Math.abs(dx)>45 && Math.abs(dy)<35){
      if(dx>0) introPrev(); else introNext();
    }
  },{passive:true});

  // 初期化
  buildCharBar();
  bestLabel.textContent = `最高 ${best}`;
  setLabels();
  selectChar(0);
</script>

</body>
</html>
